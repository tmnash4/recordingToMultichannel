<html>
<head>
  <link rel="shortcut icon" href="#">
  <script src="/socket.io/socket.io.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.js" integrity="sha512-jduERlz7En1IUZR54bqzpNI64AbffZWR//KJgF71SJ8D8/liKFZ+s1RxmUmB+bhCnIfzebdZsULwOrbVB5f3nQ==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
  <script type="text/javascript" src="ambisonics.umd.js"></script>
  

  <!-- <script src="http://127.0.0.1:3003/socket.io/socket.io.js"></script> -->

</head>
<body>
<div id="flex-container">

  <button id="record" onclick="startRecording()" >Record</button> | <button id="play" onclick="playRecording()">Play</button> | <button id="upload" onclick="uploadSample('whisper', userNumber = u, soundBlob)">Upload Latest</button>
  <button id="testing"> Testing Socket</button>
  <p id="text"> Wait for your poetry </p>
  <div id="sound-clips">
  <audio id="sound-recording" controls>
    No Audio
  </audio>
</div>

</div>

<style>
.flex-container {
  display: flex;
  flex-wrap: wrap;
  flex-direction: column;
}

#record {
  background-color:black;
  width: 50px;
  height: 50px;
  border-radius: 50%;
}

#sound-recording {
  visibility: hidden;
  width: 2px;
}


</style>

<script type="text/javascript">
var socketName = 'index';
var socket = io(); 


  let recordButton = document.getElementById("record")

  recordButton.style.backgroundColor = "black"

  function changeColor() {
  let randNum = Math.floor(Math.random() * hardy.length)

    if (recordButton.style.backgroundColor == "black") {
      recordButton.style.backgroundColor = "red";
      poemDiv.innerHTML = "Please whisper:" + hardy[randNum] 
      recordButton.style.boxShadow = "0 0 5px 5px red"
    } else {
      recordButton.style.backgroundColor = "black"
      recordButton.style.boxShadow = "0 0 0px 0px white"
    }
  }
  
  

  // function startPiece() {

  // }

  let soundClips = document.getElementById('sound-clips') // for adding audio to page
  let audio = document.getElementById('sound-recording'); // the default audio, can change src with new recordings

  let tone = Tone;
  let fileNameArray = [];

  // ---- Audio Input
  let liveFeed = new Tone.UserMedia();  // the microphone just call .open

  let recorder; // our mediaRecorder
  let soundBlob;  // our audio blob once recorded
  //let userNumber;
  let u = 0;
  let chunks = [];  // samples of audio 
  // Uncomment if you want a list of devices
  // Tone.UserMedia.enumerateDevices().then((devices) => {
  //   console.log(devices)
  // })
  let uploadButton = document.getElementById("upload")
  let test = document.getElementById("testing")
  uploadButton.addEventListener('click', () => {
    socket.emit("counter", u)
    console.log(u)
  })
  
  recordButton.addEventListener('click', () => {
    socket.emit('sendBack', true)
  })

  socket.on('send-back', (data) => {
    console.log(data)
    //u = data
  })
  //GetFolder("/uploads")




  liveFeed.open().then(()=>{
    //promise resolves when input is available
    console.log("Recorder Available")
    recorder = new MediaRecorder(liveFeed._stream);

    recorder.ondataavailable = (evt) => {
      chunks.push(evt.data);
    };

    recorder.onstop = (evt) => {
      soundBlob = new Blob(chunks, {
        type: 'audio/wav; codecs=0'
      });
      // soundBlob = new Blob(chunks, {
      //   type: 'audio/ogg; codecs=opus'
      // });

      console.log('recording stopped');
      audio.src = URL.createObjectURL(soundBlob);
      makeNewAudio(soundBlob);
      chunks = [];
      // uploadSample(this.recorder.user, currentSample, soundBlob)
    };
  }).catch(e => {
  	// promise is rejected when the user doesn't have or allow mic access
  	console.log("mic not open");
  });

  let j = 0;

  function makeNewAudio(soundBlob) {
    const newAudio = document.createElement("audio");
    newAudio.setAttribute("controls", "");
    soundClips.appendChild(newAudio);
    newAudio.controls = true;
    const audioURL = URL.createObjectURL(soundBlob);
    newAudio.src = audioURL;
    newAudio.id = "soundPlayer" + j++
  }

  // ------ Toggle recording ------
  let recording = false;
  function startRecording() {
    Tone.start();
    if (recording) {
      recorder.stop();
      recording = false;
      console.log('stopped recording')
    } else {
      recorder.start();
      recording = true;
      console.log('started recording')
    }
    changeColor()
  }




//let myAudio = new Tone.Buffer("uploads/whisper_Sample.mp3")
//let playAudio = new Tone.Player(myAudio)

  


  // function playRecording(){
  //   // audio.play();
  //  // distortRecording()
  //  granular()
  // }

  // function distortRecording() {
  //  let filter = new Tone.Filter(100, "lowpass").toDestination();
  //  //const dist = new Tone.Distortion(1).connect(filter);
  // // const crusher = new Tone.BitCrusher(10).toDestination();
  //   playAudio.connect(filter)
  //   console.log("hfff")
  //   playAudio.start()
  // }

  // function granular() {

  // let grain = new Tone.GrainPlayer(myAudio);
  // grain.grainSize = 0.9;
  // grain.overlap = 2;
  // grain.reverse = true;
  // grain.toDestination()
  // grain.start()


  // }

let hardy = [
"That whisper takes the voice", 
"Of a Spirit, speaking to me", 
"Close, but invisible", 
"And throws me under a spell",
"At the kindling vision it brings",
"And for a moment I rejoice",
"And believe in transcendent things",
"That would make of this muddy earth",
"A spot for the splendid birth",
"Of everlasting lives",
"Whereto no night arrives",
"And this gaunt gray gallery",
"A tabernacle of worth",
"On this drab-aired afternoon",
"When you can barely see",
"Across its hazed lacune",
"If opposite aught there be",
"Of fleshed humanity",
"Wherewith I may commune",
"Or if the voice so near",
"Be a soulâ€™s voice floating here.",
]
// let pieceStarted = false;
let pieceStarted

let poemDiv = document.getElementById("text");



//recordButton.addEventListener("click", lineOfPoetry)

  let i = 0;
  
  let uArray = [];

  function uploadSample(user = 'bob', userNumber = u, soundBlob) {
    console.log(u)
    let formdata = new FormData(); //create a from to of data to upload to the server
    let soundFileName = user  + '_Sample' + u;
    formdata.append('user', user);
    formdata.append('id', userNumber);
    formdata.append('soundBlob', soundBlob, soundFileName ); // append the sound blob and the name of the file. third argument will show up on the server as req.file.originalname
    
    // Now we can send the blob to a server...
    let serverUrl = '/upload'; //we've made a POST endpoint on the server at /upload
    let httpRequestOptions = { //build a HTTP POST request
      method: 'POST',
      body: formdata, // with our form data packaged above
      headers: new Headers({
        'enctype': 'multipart/form-data' // the enctype is important to work with multer on the server
      })
    };
  
    fetch(serverUrl, httpRequestOptions).then(res => {
      console.log("Uploaded: ", res)
    }).then(error => {
      if(error) {
        console.log(error)
      }
    
    });

    console.log('recording sent');
    u++
    fileNameArray.push(soundFileName + ".mp3")
    i++
    handleSubmit()
    uArray.push(u)

  };



  // test.addEventListener('click', emit)
  socket.emit('register', 'index')
  // document.addEventListener('keydown', (e) => {
  //   if (e.key == "k") {
  //     socket.emit('file-count', true)
  //     console.log("h")
  //   }
  // })
  // function emit() {
  //   socket.emit('file-count', true);
  //   console.log("f")
  // }


  let idArray = [];

  function handleSubmit() {
  let theId = "soundPlayer" + j++
  let mySubmit = document.getElementById(theId)
  idArray.push(mySubmit)
  localStorage.setItem("PLAYER", idArray.length);
  return;
}

//socket.emit('')

socket.on('send-count', (fileCount) => {
  numberOfFiles = fileCount
  console.log(numberOfFiles)
})

</script>

</body>
</html>