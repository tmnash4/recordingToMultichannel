<html>
<head>
  <link rel="shortcut icon" href="#">
  <!-- <script src="/socket.io/socket.io.js"></script> -->
  <script src="socket.io/socket.io.js"></script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.js" integrity="sha512-jduERlz7En1IUZR54bqzpNI64AbffZWR//KJgF71SJ8D8/liKFZ+s1RxmUmB+bhCnIfzebdZsULwOrbVB5f3nQ==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
  <script type="text/javascript" src="ambisonics.umd.js"></script>
  
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">

  <!-- <script src="http://127.0.0.1:3003/socket.io/socket.io.js"></script> -->

</head>
<body>
<div class="flex-container1">
  <div class="flex-items1" id="instruction">
    <h1>Whisper by Treya Nash</h1>
    <h2>with poetry by Thomas Hardy</h2>
  </div>
<div class="flex-items1" id="instructions">
 Whisper is an interactive piece that asks you to record snippets of whispered speech into your phone. You may then listen to your recorded audio, and choose to upload it or delete it. Once it is uploaded, it will become part of the collective sound played through speakers. In the first section, you will be given lines of a Thomas Hardy poem to record. In the second, you will be able to choose what to record, but your words will be obscured through various audio reshuffling techniques. Momentarily, a "start" button will appear. Click the button to continue. 
  </div>
<div class="flex-items1">
  <p></p>
  <button class="flex-items1" id="start" onclick="startPiece()"> Start Piece</button>
</div>
</div>
<div class="flex-container">
<div class="flex-items"> 
  <button id="record" onclick="startRecording()" >start recording</button> 
</div>
<div class="flex-items">  

  <button id="play" > <p id="playAud" style="position: relative; top: 10px"> play recording </p> <p id="playSymb" style="font-size: 100px; position: relative; top: -90px">  &#9658 </p> </button> 
  <!-- <img class="img" id="img2" src="./images/play.png"> -->
</div>
<div class="flex-items">  

  <button id="upload" >upload latest 
    <img class="img" src="./upload.png">
  </button>
  </div>
  <div class="flex-items"> 

 
   <button id="delete" onclick="deleteAudio()"> delete latest
    <img class="img" id="img1" src="./images/delete.png"></button>
  </div>
  </div>

    <div id="volume-visualizer"></div>
<!-- <button id="stop"> Stoah</button> -->
  <p id="text" style="display:none"> 
    Step 1: Press 'start recording' once to start recording </p>
    <p id="text1" style="display:none">Step 2: Once you hit record, a line of poetry will appear here. Whisper it into your phone.</p>
      <p id="text2" style="display:none"> Step 3: Press 'stop recording' once to stop recording</p>
        <p id="text3" style="display:none"> Step 4: Play your audio back, then decide whether to upload or delete it</p>
          <p id="text4" style="display:none">  Step 5: Repeat!</p>
  <p id="text5" style="display:none; color:rgb(255, 255, 247); font-size: 40px">Please hold the phone further from your mouth :D</p>
  <div id="peak-meter" style="height: 80px; width: 95%; visibility: hidden; margin: auto;">
    <div class="peakMeterInside" id="one"></div>
    <div class="peakMeterInside" id="two"></div>
    <div class="peakMeterInside" id="three"></div>
    <div class="peakMeterInside" id="four"></div>
    <div class="peakMeterInside" id="five"></div>
    <div class="peakMeterInside" id="six"></div>
    <div class="peakMeterInside" id="seven"></div>
    <div class="peakMeterInside" id="eight"></div>
    <div class="peakMeterInside" id="nine"></div>
    <div class="peakMeterInside" id="ten"></div>
    <div class="peakMeterInside" id="eleven"></div>
    <div class="peakMeterInside" id="twelve"></div>
    <div class="peakMeterInside" id="thirteen"></div>
    <div class="peakMeterInside" id="fourteen"></div>
    <div class="peakMeterInside" id="fifteen"></div>
    <div class="peakMeterInside" id="sixteen"></div>
    <div class="peakMeterInside" id="seventeen"></div>
    <div class="peakMeterInside" id="eighteen"></div>
    <div class="peakMeterInside" id="nineteen"></div>
    <div class="peakMeterInside" id="twenty"></div>

  </div>

    
    <!-- When you begin to record, text will appear on the screen. Please whisper the text into your phone, then press the button again to stop recording. Once you have stopped recording, you can listen to your audio and then upload or delete it. Repeat  </p> -->
  <div id="sound-clips">
    <p id="myTitle"> </p>
  <audio id="sound-recording" >
    No Audio
  </audio>
</div>


<!-- <button id="start">Start</button>
<button id="stop">Stop</button> -->

<style>

body {
  font-family: 'Times New Roman', Times, serif;
  background-color: rgb(255, 255, 247);
  font-size: 2em;

}

#peak-meter {
  display: flex;
  background-color: black;
  border: 5px rgb(156, 149, 128) solid;

}

.peakMeterInside {
  width:20%;
  height:98%;
  background-color: white;
  border: white 1px solid
}




.flex-container {
  display: flex;
  position: relative;
  margin: 0 auto;
  width: 100%;
  flex-wrap: wrap;
  justify-content: space-evenly;
  align-content: center;
  flex-direction: row;
  text-align: center
  /* background-color: blue; */
  /* flex-direction: column; */
}

 .flex-items {
  flex: 1 0 25%;
  max-width: 25%;
  overflow: hidden;
  /* margin-top: 50px; */
  margin-bottom: 60px
  /* background-color: red */
  /* position: absolute */
} 

.flex-container1 {
  display: flex;
  position: relative;
  margin: 0 auto;
  width: 100%;
  height: 100%;
  flex-wrap: wrap;
  justify-content: space-evenly;
  /* align-content: center; */
  flex-direction: row;
  text-align: center
  /* background-color: blue; */
  /* flex-direction: column; */
}

 .flex-items1 {
  flex: 1 0 100%;
  max-width: 100%;
  /* overflow: hidden; */
  margin-top: 100px
  /* background-color: red */
  /* position: absolute */
} 

@media screen and (min-width: 800px) {
  #instructions {
  width: 30px;
  font-size: 1.75em;
  margin-top: -80px; 
  margin-left: 40px;
  margin-right: 40px
}
}

#instructions {
  width: 30px;
  font-size: 1.75em;
  margin-top: 80px; 
  margin-left: 40px;
  margin-right: 40px
}

#start {
  /* width: 10%;
  height: 20%; */
  font-size: 1.8em;
  font-family: inherit;
  border: none;
  background-color: green;
  border-radius: 5%;
  color: rgb(255, 255, 247);
  margin-top: -100px
  /* margin-top: -1000px */
}

#record {
    /* position: relative; */

  background-color:black;
  width: 200px;
  height: 200px;
  border-radius: 50%;
  visibility: hidden;
  font-family: 'Times New Roman', Times, serif;
}

#play {
  /* position: relative; */
  /* position: absolute; */
  background-color: rgb(26, 209, 26);
  width: 200px;
  height: 200px;
  border-radius: 50%;
  border: 5px rgb(26, 209, 26) solid;
  font-family: 'Times New Roman', Times, serif;
  font-size: 20px;
  /* left: 220px; */
  visibility: hidden;
}

#upload {
  /* position: relative; */
  /* position: absolute; */
  background-color: lightskyblue;
  width: 200px;
  height: 200px;
  border-radius: 50%;
  border: 5px lightskyblue solid;
  font-family: 'Times New Roman', Times, serif;
  font-size: 20px;
  /* left: 432px */
}

#delete {
  /* position: relative; */
  /* position: absolute; */
  background-color: rgb(239, 132, 132);
  width: 200px;
  height: 200px;
  border-radius: 50%;
  border: 5px rgb(239, 132, 132) solid;
  font-family: 'Times New Roman', Times, serif;
  font-size: 20px;
  /* left: 642px; */
  visibility: hidden;
}
.img {
  position: relative;
  width: 100px;
  height: 100px
}

#img1 {
  top: 5px;
}
#img2 {
  left: 5px;
}
.audioClass {
  width: 600px;
 
}
#sound-recording {
  visibility: hidden;
  width: 2px;
}

#text {
  visibility: hidden;
  font-size: 50px;
  margin-left: 15px
}
#text1 {
  visibility: hidden;
  font-size: 50px;
  white-space: pre-wrap;
  margin-left: 15px
}
#text2 {
  visibility: hidden;
  font-size: 50px;
  margin-left: 15px
}
#text3 {
  visibility: hidden;
  font-size: 50px;
  margin-left: 15px
}

#text4 {
  /* visibility: hidden; */
  font-size: 50px;
  margin-left: 15px
}


#upload {
  visibility: hidden
}

#myTitle {
  visibility: hidden;
  font-size: 30px;
}

#volume-visualizer {
  display: none;
  --volume: 0%;
  position: relative;
  width: 50%;
  height: 20px;
  margin-top: 50px;
  background-color: #DDD;
}

#volume-visualizer::before {
   content: '';
   position: absolute;
   top: 0;
   bottom: 0;
   left: 0;
   width: var(--volume);
   background-color: green;
   transition: width 100ms linear;
}

/* button {
  margin-left: 50px;
} */

h3 {
  margin: 20px;
  font-family: sans-serif;
}

</style>

<script type="text/javascript">
var socketName = 'index';
var socket = io(); 
  let body = document.querySelector("body")
  const meterElement = document.getElementById('peak-meter');
  let recordButton = document.getElementById("record")
  let peakMeter = document.getElementById("peak-meter")


  let uploadButton = document.getElementById("upload");
  uploadButton.addEventListener("click", ()=> {
    if (peakLevel == 0) {
     uploadSample('whisper', userNumber = today, soundBlob)
    } else {
      console.log("not today buddy")
      peakLevel = 0;
    }
  })

  let deleteButton = document.getElementById("delete");
  let poemLine = 0;
  let text = document.querySelector("#text");
  let text1 = document.querySelector("#text1");
  let text2 = document.querySelector("#text2");
  let text3 = document.querySelector("#text3");
  let text4 = document.querySelector("#text4");
  let text5 = document.querySelector("#text5")
  uploadButton.style.color = "white"
  deleteButton.style.color = "white"
  

  text.style.color = "blue"
  // text3.style.color = "black"
  recordButton.style.boxShadow = "0 0 2px 2px white"

  let test1 = 0
  let test2 = 1
let myInt;
  let sec2text1 = 0;
 // text.style.color = "blue"
  function changeColor() {

  let randNum = Math.floor(Math.random() * hardy.length)
  //poemLine = 0;
  recordButton.style.opacity = 0.9;
  let refreshIntervalId = setInterval(flashColor, 1000);
  poemLine++
    if (!test1) {
      peakMeter.style.visibility = "visible"
      recordButton.style.backgroundColor = "red";
       text.style.color = "black";
       text1.style.color = "blue";
       text2.style.color = "blue"
       text3.style.color = "black"
       text4.style.color = "black"
      recordButton.style.boxShadow = "0 0 2px 2px red"
      recordButton.innerHTML = "stop recording"
      uploadButton.style.visibility = "hidden"
      deleteButton.style.visibility = "hidden"
      playButton.style.visibility = "hidden"
      test1 = 1;
      myInt = setInterval(checkForScream, 100)
      text5.style.display="flex"
      // poemLine = 0;
      // poemLine++
     
      // if (poemLine <=24) {
        // text1.style.width = "100%"
       text1.innerHTML = "Step 2: Whisper the following line of poetry into your phone: " + "<br>" + "<br>" + "         " + '"' + hardy[randNum] + '"'
        // let newLine = document.createElement("div");
        // text1.appendChild(newLine)
      // } else {
      //   poemDiv1.innerHTML = "That's good for now, thanks!"
      //   recordButton.style.visibility = "hidden"
      // }
    } else if (recordButton.style.backgroundColor =="red" && test2 == 1) {

      peakMeter.style.visibility = "hidden"
      recordButton.style.visibility = "hidden";
      clearInterval(refreshIntervalId)
      clearInterval(myInt)
      text5.style.display="none"
      text.style.color = "black"
      text1.style.color = "black"
      text2.style.color = "black"
      text3.style.color = "blue"
      text4.style.color = "black"
      uploadButton.style.visibility = "visible"
      deleteButton.style.visibility = "visible"
      playButton.style.visibility = 'visible'
      myTitle.style.visibility = "visible"
      test1 = 0;
    
    
    } else if (!test2) {
      text1.style.color = "black"
      text2.style.color = "black"
      text3.style.color = "black"
      //text4.style.color = "blue"
      test2 = 1;

    }
    //poemLine++
    console.log(poemLine + "hehe")
  }

function flashColor() {
  if (recordButton.style.opacity == 0.9) {
    recordButton.style.opacity = 0.5
  } else if (recordButton.style.opacity == 0.5) {
    recordButton.style.opacity = 0.9
  }
}




  function changeColor1() {
    let randNum = Math.floor(Math.random() * hardy.length)
  //poemLine = 0;
  recordButton.style.opacity = 0.9;
  let refreshIntervalId = setInterval(flashColor, 1000);

    if (!test1) {
      recordButton.style.backgroundColor = "red";
       text.style.color = "blue";
      recordButton.style.boxShadow = "0 0 2px 2px red"
      recordButton.innerHTML = "stop recording"
      uploadButton.style.visibility = "hidden"
      deleteButton.style.visibility = "hidden"
      playButton.style.visibility = "hidden"
      test1 = 1;
      text.innerHTML = "You're recording, whisper something to me!"
   
     
    } else if (recordButton.style.backgroundColor =="red") {
      recordButton.style.visibility = "hidden";
      clearInterval(refreshIntervalId)
      text.style.color = "black"
      uploadButton.style.visibility = "visible"
      deleteButton.style.visibility = "visible"
      playButton.style.visibility = 'visible'
      myTitle.style.visibility = "visible"
      test1 = 0;
      text.innerHTML = "You've stopped recording! Listen to your audio, and then you can choose to upload or delete it."
    
    }
  }
  

  uploadButton.addEventListener("click", () => {
    recordButton.style.visibility = "visible"
    recordButton.style.backgroundColor = "black"
      recordButton.style.boxShadow = "0 0 0px 0px white"
      recordButton.style.color = "white"
      recordButton.innerHTML = "start recording"
    text.style.color = "black"
    uploadButton.style.visibility = "hidden"
    deleteButton.style.visibility = "hidden"
    playButton.style.visibility = "hidden"
    recordButton.style.opacity = 1
    if (sec2text1 == 1) {
    text.innerHTML = "What will you choose to whisper next? Press the record button again when you're ready!"
    } else if (!sec2text1) {
      text.style.color = "blue"
      text3.style.color = "black"
    }
    // myImg.src = "./images/play.png"
  })

  deleteButton.addEventListener("click", () => {
    recordButton.style.visibility = "visible"
    recordButton.style.backgroundColor = "black"
      recordButton.style.boxShadow = "0 0 0px 0px white"
      recordButton.style.color = "white"
      recordButton.innerHTML = "start recording"
    text3.style.color = "black"
    if (sec2text1 == 1) {
    text.innerHTML = "What will you choose to whisper next? Press the record button again when you're ready!"
    } else if (!sec2text1) {
      text.style.color = "blue"
      text3.style.color = "black"
    }
    deleteButton.style.visibility = "hidden"
    uploadButton.style.visibility = "hidden"
    playButton.style.visibility = "hidden"
    recordButton.style.opacity = 1
    text1.innerHTML = "Step 2: Once you hit record, a line of poetry will appear here. Whisper it into your phone."

  })

  document.addEventListener("keydown", (e) => {
    if (e.key == "b") {
    socket.emit("begin", true)
    } else if (e.key =="e") {
    socket.emit("sec2", true)
    socket.emit('sendFileName1', true)
        console.log("2go")
    } else if (e.key == "r") {
      socket.emit("secEnd", true)
    } else if (e.key == "w") {
      socket.emit("justListen", true)
    } else if (e.key == "q") {
      socket.emit("startSec", true)
    } else if (e.key == "t") {
      socket.emit("end", true)
    } else if (e.key == "u") {
      socket.emit("sec1", true)
    }
  })
  
//   socket.on("set_section", (data) => {
//   if (data == "startRecording") {
//   console.log("its beginning")
//   startPiece()

  
//   } else if (data == "secondSection") {
//     section2()
  
//   }
// })
let instructions = document.querySelector("#instructions")
let instructions1 = "Whisper is an interactive piece that asks you to record snippets of whispered speech into your phone. You may then listen to your recorded audio, and choose to upload it or delete it. Once it is uploaded, it will become part of the collective sound played through speakers. In the first section, you will be give lines of a Thomas Hardy poem to record. In the second, you will be able to choose what to record, but your words will be obscured through various audio reshufling techniques. Momentarily, a 'start' button will appear. Click the button to continue."
let header = document.querySelector("#instruction")
let secondFlex = document.querySelector(".flex-container")
let firstFlex = document.querySelector(".flex-container1")
secondFlex.style.display = "none"

let poemDiv1 = document.getElementById("text1")
// poemDiv1.style.textAlign = "left"

let startButton = document.getElementById("start");
startButton.style.visibility = "hidden"
startButton.addEventListener("click", () => {
  piecePreview()
})
function piecePreview() {
  
  body.style.backgroundColor = "rgb(255, 255, 247)";
  firstFlex.style.display = "none"
  secondFlex.style.display = "flex"
  text.style.display= "flex";
  text1.style.display= "flex";
  text2.style.display= "flex";
  text3.style.display= "flex";
  text4.style.display="flex"

  startPiece()
}


function resetToPre() {
  body.style.backgroundColor = "rgb(255, 255, 247)";
  firstFlex.style.display = "flex"
  instructions.innerHTML = instructions1
  header.style.visibility = "visible"
  secondFlex.style.display = "none"
  text.style.display= "none";
  text1.style.display= "none";
  text2.style.display= "none";
  text3.style.display= "none";
  text4.style.display="none";
  startButton.style.visibility = "hidden"
  console.log("resetting now")
}


function startPiece() {
  body.style.backgroundColor = "rgb(255, 255, 247)";
  secondFlex.style.display = "flex"
  recordButton.style.visibility = "visible";
  text.innerHTML = "Step 1: Press 'start recording' once to start recording"
  text.style.visibility = "visible";
  text1.style.visibility = "visible";
  text2.style.visibility = "visible";
  text3.style.visibility = "visible";
  recordButton.removeEventListener("click", changeColor1)
  recordButton.addEventListener("click", changeColor)
  poemLine = 0
  startButton.style.visibility = "hidden"

}


function section2() {
  body.style.backgroundColor = "rgb(255, 255, 247)";
  secondFlex.style.display = "flex"
  text.style.display= "flex";
  recordButton.style.visibility = "visible";
  text.style.visibility = "visible";
  recordButton.removeEventListener("click", changeColor)
  recordButton.addEventListener("click", changeColor1);
  text.innerHTML = "For this section, record yourself whispering whatever words/phrases you like. Your words will be obscured using audio processing techniques."
  text.style.color = "black"
  text1.style.visibility = "hidden"
  text2.style.visibility = "hidden"
  text3.style.visibility = "hidden"
  text4.style.visibility = "hidden"
  firstFlex.style.display = "none"
  sec2text1 = 1
  startButton.style.visibility = "hidden"



}

function endPiece() {
  body.style.backgroundColor = "rgb(255, 255, 247)";
  secondFlex.style.display = "none";
  text.style.display = "none"
  text1.style.display = "none"
  text2.style.display = "none"
  text3.style.display = "none"
  firstFlex.style.display = "flex"
  // firstFlex.style.top = "47%"
  instructions.innerHTML = "The piece is now ending, listen to the whispers as they fade out! Thanks for participating! :)"
  header.style.visibility = "hidden"
  startButton.style.visibility = "hidden"

}

function endPieceFully() {
  // let body = document.querySelector("body");
  firstFlex.style.display = "none"
  secondFlex.style.display = "none"
  body.style.backgroundColor = "black";
  startButton.style.visibility = "hidden"

}


function justListen() {
  instructions.innerHTML = "Let's take a break from recording and just listen for a few moments."
  header.style.visibility = "hidden"
  body.style.backgroundColor = "rgb(255, 255, 247)";
  secondFlex.style.display = "none";
  text.style.display = "none"
  text1.style.display = "none"
  text2.style.display = "none"
  text3.style.display = "none"
  text4.style.display = "none"
  firstFlex.style.display = "flex"
  startButton.style.visibility = "hidden"
}

  let soundClips = document.getElementById('sound-clips') // for adding audio to page
  let audio = document.getElementById('sound-recording'); // the default audio, can change src with new recordings

  let tone = Tone;
  let fileNameArray = [];
  let myCount = 0;
  let today;

  // ---- Audio Input
  let liveFeed = new Tone.UserMedia();  // the microphone just call .open

  let recorder; // our mediaRecorder
  let soundBlob;  // our audio blob once recorded
  let u = 0;
  let chunks = [];  // samples of audio 
  // Uncomment if you want a list of devices
  // Tone.UserMedia.enumerateDevices().then((devices) => {
  //   console.log(devices)
  // })
  let test = document.getElementById("testing")
  uploadButton.addEventListener('click', () => {
    socket.emit("counter", u)
    //console.log(u)
  })

  uploadButton.addEventListener('click', () => {
    socket.emit('file-name', fileNameArray.toString())
  })
  
  recordButton.addEventListener('click', () => {
    socket.emit('sendBack', true)
  })

  socket.on('send-back', (data) => {
    //console.log(data)
    myCount = data
  })
  //GetFolder("/uploads")

function sendNumber() {
socket.emit('correctNumber', today)
}

let playButton = document.getElementById("play");
let playText = document.getElementById("playAud");
let playSymbol = document.getElementById("playSymb");
playButton.style.color = "white"

let peak1 = document.getElementById("one");
let peak2 = document.getElementById("two")
let peak3 = document.getElementById("three")
let peak4 = document.getElementById("four")
let peak5 = document.getElementById("five")
let peak6 = document.getElementById("six")
let peak7 = document.getElementById("seven")
let peak8 = document.getElementById("eight")
let peak9 = document.getElementById("nine")
let peak10 = document.getElementById("ten")
let peak11 = document.getElementById("eleven");
let peak12 = document.getElementById("twelve")
let peak13 = document.getElementById("thirteen")
let peak14 = document.getElementById("fourteen")
let peak15 = document.getElementById("fifteen")
let peak16 = document.getElementById("sixteen")
let peak17 = document.getElementById("seventeen")
let peak18 = document.getElementById("eighteen")
let peak19 = document.getElementById("nineteen")
let peak20 = document.getElementById("twenty")

let peakArray = [peak1, peak2, peak3, peak4, peak5, peak6, peak7, peak8, peak9, peak10, peak11, peak12, peak13, peak14, peak15,peak16, peak17, peak18, peak19, peak20]

let peakLevel = 0;

function checkForScream() {
   
    let level = meter.getValue();
    console.log(level)
    //text1.innerHTML = level
    if (level <= -90) {
      for (i=0; i<1; i++) {
        peakArray[i].style.backgroundColor = "green"
      }
      for (i=1;i<peakArray.length;i++) {
        peakArray[i].style.backgroundColor = "white"
      }  
    } else if (level > -90 && level <= -63) {
      for (i=0; i<2; i++) {
        peakArray[i].style.backgroundColor = "green"
      }
      for (i=2;i<peakArray.length;i++) {
        peakArray[i].style.backgroundColor = "white"
      }  
    } else if (level > -63 && level <= -60 ) {
      for (i=0; i<3; i++) {
        peakArray[i].style.backgroundColor = "green"
      }
      for (i=3;i<peakArray.length;i++) {
        peakArray[i].style.backgroundColor = "white"
      }  

    } else if (level > -60 && level <= -57) {
      for (i=0; i<4; i++) {
        peakArray[i].style.backgroundColor = "green"
      }
      for (i=4;i<peakArray.length;i++) {
        peakArray[i].style.backgroundColor = "white"
      }  

   
    } else if (level > -57 && level <= -54) {
      for (i=0; i<5; i++) {
        peakArray[i].style.backgroundColor = "green"
      }
      for (i=5;i<peakArray.length;i++) {
        peakArray[i].style.backgroundColor = "white"
      }  

   
    } else if (level > -54 && level <= -51) {
      for (i=0; i<6; i++) {
        peakArray[i].style.backgroundColor = "green"
      }
      for (i=6;i<peakArray.length;i++) {
        peakArray[i].style.backgroundColor = "white"
      }  

   
    } else if (level > -51 && level <= -48) {
      for (i=0; i<7; i++) {
        peakArray[i].style.backgroundColor = "green"
      }
      for (i=7;i<peakArray.length;i++) {
        peakArray[i].style.backgroundColor = "white"
      }  

   
    } else if (level > -48 && level <= -45) {
      for (i=0; i<8; i++) {
        peakArray[i].style.backgroundColor = "green"
      }
      for (i=8;i<peakArray.length;i++) {
        peakArray[i].style.backgroundColor = "white"
      }  

   
    } else if (level > -45 && level <= -42) {
      for (i=0; i<9; i++) {
        peakArray[i].style.backgroundColor = "green"
      }
      for (i=8;i<peakArray.length;i++) {
        peakArray[i].style.backgroundColor = "white"
      }  


    } else if (level > -42 && level <= -40) {
      for (i=0; i<10; i++) {
        peakArray[i].style.backgroundColor = "green"
      }
      for (i=10;i<peakArray.length;i++) {
        peakArray[i].style.backgroundColor = "white"
      }  

    } else if (level > -40 && level <= -38) {
      for (i=0; i<11; i++) {
        peakArray[i].style.backgroundColor = "green"
      }
      for (i=11;i<peakArray.length;i++) {
        peakArray[i].style.backgroundColor = "white"
      }  
    } else if (level > -38 && level <= -36) {
      for (i=0; i<12; i++) {
        peakArray[i].style.backgroundColor = "green"
      }
      for (i=12;i<peakArray.length;i++) {
        peakArray[i].style.backgroundColor = "white"
      }  
    } else if (level > -36 && level <= -34) {
      for (i=0; i<13; i++) {
        peakArray[i].style.backgroundColor = "yellow"
      }
      for (i=13;i<peakArray.length;i++) {
        peakArray[i].style.backgroundColor = "white"
      }  
    } else if (level > -34 && level <= -32) {
      for (i=0; i<14; i++) {
        peakArray[i].style.backgroundColor = "yellow"
      }
      for (i=14;i<peakArray.length;i++) {
        peakArray[i].style.backgroundColor = "white"
      }  
    } else if (level > -32 && level <= -30) {
      for (i=0; i<15; i++) {
        peakArray[i].style.backgroundColor = "yellow"
      }
      for (i=15;i<peakArray.length;i++) {
        peakArray[i].style.backgroundColor = "white"
      }  
    } else if (level > -30 && level <= -28) {
      for (i=0; i<16; i++) {
        peakArray[i].style.backgroundColor = "yellow"
      }
      for (i=16;i<peakArray.length;i++) {
        peakArray[i].style.backgroundColor = "white"
      }  
    } else if (level > -28 && level <= -26) {
      for (i=0; i<17; i++) {
        peakArray[i].style.backgroundColor = "yellow"
      }
      for (i=17;i<peakArray.length;i++) {
        peakArray[i].style.backgroundColor = "white"
      }  
    } else if (level > -26 && level <= -24) {
      text5.style.color = "black"
        setTimeout(() => {
          text5.style.color = "rgb(255, 255, 247)"
        }, 2000)
      for (i=0; i<18; i++) {
        peakArray[i].style.backgroundColor = "red"
        
      }
      for (i=18;i<peakArray.length;i++) {
        peakArray[i].style.backgroundColor = "white"
      } 
    } else if (level > -24 && level <= -22) {
      text5.style.color = "black"
        setTimeout(() => {
          text5.style.color = "rgb(255, 255, 247)"
        }, 2000)
      for (i=0; i<19; i++) {
        peakArray[i].style.backgroundColor = "red"
        
      }
      
      for (i=19;i<peakArray.length;i++) {
        peakLevel = 1
        peakArray[i].style.backgroundColor = "white"
      } 
    } else if (level > -22 && level <= -20) {

      text5.style.color = "black"
        setTimeout(() => {
          text5.style.color = "rgb(255, 255, 247)"
        }, 2000)
     
      for (i=0; i<peakArray.length; i++) {
        peakArray[i].style.backgroundColor = "red"
        
      }
      
   
    } else {
      for (i=0; i<peakArray.length; i++) {
        peakArray[i].style.backgroundColor = "white"
      }

    }
    
}


  liveFeed.open().then(()=>{

    //promise resolves when input is available
    console.log("Recorder Available")
    recorder = new MediaRecorder(liveFeed._stream);

    recorder.ondataavailable = (evt) => {
      chunks.push(evt.data);
    };

    recorder.onstop = (evt) => {
      soundBlob = new Blob(chunks, {
        type: 'audio/wav; codecs=0'
      });
      // soundBlob = new Blob(chunks, {
      //   type: 'audio/ogg; codecs=opus'
      // });

      console.log('recording stopped');
      audio.src = URL.createObjectURL(soundBlob);
      makeNewAudio(soundBlob);
      chunks = [];
      // uploadSample(this.recorder.user, currentSample, soundBlob)
    };
  }).catch(e => {
  	// promise is rejected when the user doesn't have or allow mic access
  	console.log("mic not open");
  });

  const meter = new Tone.Meter()
let screamFilter = new Tone.Filter({
    Q: 20,
    frequency: 2500,
    roloff: -48,
    type: "bandpass"
}) 
//screamFilter.connect(meter);
liveFeed.connect(meter)
let screamIsPlaying = false;

 // let audioPeakMeter = new webAudioPeakMeter.WebAudioPeakMeter(meter.getValue(), meterElement);

  let men1 = 0;
  let j = 0;
  let k = 0;
  let srcArray = [];
  let newAudio;
  let newAudio1
  let myTitle = document.getElementById("myTitle");
  let myImg = document.getElementById("img2")
  function makeNewAudio(soundBlob) {
    // let newTitle = document.createElement("p");
    // soundClips.appendChild(newTitle);
    // newTitle.innerHTML = "Listen here before uploading"
    //myTitle.style.visibility = "hidden"
    men1 = 0;
    newAudio1 = new Tone.Buffer(soundBlob)
    newAudio = document.createElement("audio");
    newAudio.type = "audio/mpeg"
    //newAudio.setAttribute("controls", "");
    playButton.appendChild(newAudio);
    newAudio.style.width = "0px"
    

    
  

    console.log(newAudio)
    newAudio.controls = false;
    newAudio.preload = "metadata";
    const audioURL = URL.createObjectURL(soundBlob);
    //newAudio.style.visibility = "hidden"
    var sourceElement = document.createElement('source') //THIS ALLOWS SAFARI TO PLAY IT!!!
    newAudio.appendChild(sourceElement)
    //newAudio.src = audioURL;
    sourceElement.src = audioURL
    sourceElement.type = 'audio/mp3' // or whatever
    newAudio.type = 'audio/mp3'
    newAudio.id = "soundPlayer" + k++
    newAudio.classList.add('audioClass')
  
    srcArray.push(newAudio.id);
    //console.log(srcArray)
    //console.log(newAudio.duration)
    
    
  }

  playButton.addEventListener('click', () => {
      if (men1 == 0) {
      playText.innerHTML = "pause recording";
      playSymbol.innerHTML = "&#9612; &#9612";
      playSymbol.style.left = "10px";
      playSymbol.style.fontSize = "60px";
      playSymbol.style.top = "-30px"
      playSymbol.style.position = "relative"
      newAudio.play()
       men1 = 1
      } else if (men1 == 1) {
        // myImg.src = "./images/play.png"
        newAudio.pause()
        men1 = 0;
        playText.innerHTML = "play recording";
        playSymbol.innerHTML = "&#9658";
        playSymbol.style.fontSize = "100px";
        playSymbol.style.top = "-90px"
      playSymbol.style.position = "relative"

      }
      // let duration = newAudio.duration;

      function switch1() {
        newAudio.pause()
        men1 = 0;
        playText.innerHTML = "play recording";
        playSymbol.innerHTML = "&#9658";
        playSymbol.style.fontSize = "100px";
        playSymbol.style.top = "-90px"
      playSymbol.style.position = "relative"

      }
      //console.log(Math.abs(timeElapsed))
      setTimeout(switch1, timeElapsed + 1000)

      })

let soundP = 0

function deleteAudio() {
    //let soundP = 0;
    let id1 = "soundPlayer" + soundP++
    let deleteAudio = document.getElementById(id1)
    console.log(id1)
    deleteAudio.remove()
    // test2 = 0;


}

let timeElapsed;
let startTime;
  // ------ Toggle recording ------
  let recording = false;
  function startRecording() {
    Tone.start();
    if (recording) {
      recorder.stop();
      recording = false;
      console.log('stopped recording')
      men1 = 0
      timeElapsed = new Date().getTime() - startTime
    } else {
      recorder.start();
      recording = true;
      console.log('started recording')
      startTime = new Date().getTime()
    }
  
  }




//let myAudio = new Tone.Buffer("uploads/whisper_Sample.mp3")
//let playAudio = new Tone.Player(myAudio)

  


  // function playRecording(){
  //   // audio.play();
  //  // distortRecording()
  //  granular()
  // }

  // function distortRecording() {
  //  let filter = new Tone.Filter(100, "lowpass").toDestination();
  //  //const dist = new Tone.Distortion(1).connect(filter);
  // // const crusher = new Tone.BitCrusher(10).toDestination();
  //   playAudio.connect(filter)
  //   console.log("hfff")
  //   playAudio.start()
  // }

  // function granular() {

  // let grain = new Tone.GrainPlayer(myAudio);
  // grain.grainSize = 0.9;
  // grain.overlap = 2;
  // grain.reverse = true;
  // grain.toDestination()
  // grain.start()


  // }

let hardy = [
"That whisper takes the voice", 
"Of a Spirit, speaking to me", 
"Close, but invisible", 
"And throws me under a spell",
"At the kindling vision it brings",
"And for a moment I rejoice",
"And believe in transcendent things",
"That would make of this muddy earth",
"A spot for the splendid birth",
"Of everlasting lives",
"Whereto no night arrives",
"And this gaunt gray gallery",
"A tabernacle of worth",
"On this drab-aired afternoon",
"When you can barely see",
"Across its hazed lacune",
"If opposite aught there be",
"Of fleshed humanity",
"Wherewith I may commune",
"Or if the voice so near",
"Be a soul’s voice floating here.",
]
// let pieceStarted = false;
let pieceStarted

let poemDiv = document.getElementById("text");




  let i = 0;
  
  let uArray = [];

  let replaceSample = '_Sample'

  // function uploadSample(user = 'bob', userNumber = myCount, soundBlob) {
    function uploadSample(user = 'bob', userNumber = today, soundBlob) {
    today = new Date().getTime()
    let formdata = new FormData(); //create a from to of data to upload to the server
    let soundFileName = user  + '_Sample' + today;
    sendNumber()
    console.log(today)
    formdata.append('user', user);
    formdata.append('id', today);
    formdata.append('soundBlob', soundBlob, soundFileName ); // append the sound blob and the name of the file. third argument will show up on the server as req.file.originalname
    
    // Now we can send the blob to a server...
    let serverUrl = '/upload'; //we've made a POST endpoint on the server at /upload
    let httpRequestOptions = { //build a HTTP POST request
      method: 'POST',
      body: formdata, // with our form data packaged above
      headers: new Headers({
        'enctype': 'multipart/form-data' // the enctype is important to work with multer on the server
      })
    };
  
    fetch(serverUrl, httpRequestOptions).then(res => {
      console.log("Uploaded: ", res)
    }).then(error => {
      if(error) {
        console.log(error)
      }
    
    });

    console.log('recording sent');
    fileNameArray.push(soundFileName + ".wav")
    handleSubmit()
    deleteAudio()
  };



  // test.addEventListener('click', emit)
  socket.emit('register', 'index')
  // document.addEventListener('keydown', (e) => {
  //   if (e.key == "k") {
  //     socket.emit('file-count', true)
  //     console.log("h")
  //   }
  // })
  // function emit() {
  //   socket.emit('file-count', true);
  //   console.log("f")
  // }


  let idArray = [];

  function handleSubmit() {
  let theId = "soundPlayer" + j++
  let mySubmit = document.getElementById(theId)
  idArray.push(mySubmit)
  localStorage.setItem("PLAYER", idArray.length);
  return;
}

let numz = 0;
//socket.emit('')

socket.on('send-count', (fileCount) => {
  numberOfFiles = fileCount
  console.log(numberOfFiles)
})
async function myFunction() {
  let volumeCallback = null;
  let volumeInterval = null;
  const volumeVisualizer = document.getElementById('volume-visualizer');
  let recordButton1 = document.getElementById('record');
  // const stopButton = document.getElementById('stop');
  // Initialize
  try {
    const audioStream = await navigator.mediaDevices.getUserMedia({
      audio: {
        echoCancellation: true
      }
    });
    const audioContext = new AudioContext();
    const audioSource = audioContext.createMediaStreamSource(audioStream);
    const analyser = audioContext.createAnalyser();
    analyser.fftSize = 512;
    analyser.minDecibels = -127;
    analyser.maxDecibels = 0;
    analyser.smoothingTimeConstant = 0.4;
    audioSource.connect(analyser);
    const volumes = new Uint8Array(analyser.frequencyBinCount);
    volumeCallback = () => {
      analyser.getByteFrequencyData(volumes);
      let volumeSum = 0;
      for(const volume of volumes) 
        volumeSum += volume;
      const averageVolume = volumeSum / volumes.length;
    //   stopButton.addEventListener('click', () => {
    //   console.log(averageVolume * 100 / 127)
    // })
      // Value range: 127 = analyser.maxDecibels - analyser.minDecibels;
      volumeVisualizer.style.setProperty('--volume', (averageVolume * 100 / 127) + '%');
    };
  } catch(e) {
    console.error('Failed to initialize volume visualizer, simulating instead...', e);
    // Simulation
    //TODO remove in production!
    let lastVolume = 50;
    volumeCallback = () => {
      const volume = Math.min(Math.max(Math.random() * 100, 0.8 * lastVolume), 1.2 * lastVolume);
      lastVolume = volume;
      volumeVisualizer.style.setProperty('--volume', volume + '%');
    };
  }
  // Use
  recordButton1.addEventListener('click', () => {
  
    if (!numz) {
    // Updating every 100ms (should be same as CSS transition speed)
    if(volumeCallback !== null && volumeInterval === null) {
      volumeInterval = setInterval(volumeCallback, 100);
      numz = 1
    } 
  }else {
      if(volumeInterval !== null) {
      clearInterval(volumeInterval);
      volumeInterval = null;
      numz = 0
    }

    }
  });
;
}

myFunction()


function leadInToFirstSection() {
  startButton.style.visibility = "visible"
  body.style.backgroundColor = "rgb(255, 255, 247)";
  firstFlex.style.display = "flex"
  secondFlex.style.display = "none"
  text.style.display= "none";
  text1.style.display= "none";
  text2.style.display= "none";
  text3.style.display= "none";
  text4.style.display="none";
  instructions.innerHTML = instructions1
  header.style.visibility = "visible"
}

socket.on("set_section", (data) => {
  if (data == "zero") {
    console.log("This is the pre section")
    resetToPre()
  } else if (data == "one") {
    leadInToFirstSection()
  } else if (data =="two") {
    console.log("This is the first section")
    startPiece()
    piecePreview()
  } else if (data == "three") {
    justListen()
   }else if (data =="four") {
    section2()
    console.log("This is the second section")
  } else if (data == "five") {
    console.log("This is the third section")
    endPiece()
  }  else if (data == "six") {
    endPieceFully()
  }
})



</script>

<style>
 #record {
    background-color: black;
    color: white;
    font-size: 30px;
  }




</style>

</body>
</html>